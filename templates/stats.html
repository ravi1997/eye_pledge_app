{% extends "base.html" %}

{% block title %}{{ _('Live Impact Dashboard') }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">

    <!-- Hero Stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
        <!-- Total Pledges -->
        <div
            class="bg-gradient-to-br from-brand-600 to-brand-800 rounded-3xl p-8 text-white relative overflow-hidden shadow-xl">
            <div class="absolute top-0 right-0 -mr-8 -mt-8 w-32 h-32 bg-white opacity-10 rounded-full blur-2xl"></div>
            <div class="relative z-10">
                <div class="flex items-center gap-3 mb-2 opacity-90">
                    <i class="bi bi-heart-pulse-fill"></i>
                    <span class="text-sm font-bold uppercase tracking-wider">{{ _('Total Pledges') }}</span>
                </div>
                <div class="text-6xl font-black mb-2">{{ total_pledges }}</div>
                <p class="text-brand-100 text-sm">{{ _('Lives potentially impacted') }}: <span class="font-bold">{{
                        total_pledges * 2 }}</span></p>
            </div>
        </div>

        <!-- Today's Pledges -->
        <div class="bg-white rounded-3xl p-8 border border-slate-200 shadow-xl relative overflow-hidden">
            <div class="flex items-center justify-between relative z-10 h-full">
                <div>
                    <div class="flex items-center gap-3 mb-2 text-slate-500">
                        <i class="bi bi-calendar-check-fill text-green-500"></i>
                        <span class="text-sm font-bold uppercase tracking-wider">{{ _('Joined Today') }}</span>
                    </div>
                    <div class="text-6xl font-black text-slate-900 mb-2">{{ today_pledges }}</div>
                    <div class="text-slate-500 text-sm">{{ _('Heroes pledged their eyes today') }}</div>
                </div>
                <div class="hidden md:block">
                    <!-- Circular Progress or Icon -->
                    <div
                        class="w-20 h-20 rounded-full bg-green-50 flex items-center justify-center text-green-600 text-3xl">
                        <i class="bi bi-graph-up-arrow"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-16">

        <!-- Monthly Progress -->
        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
            <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                <i class="bi bi-calendar-month text-brand-500"></i> {{ _('Pledges in') }} {{ current_year }}
            </h3>
            <canvas id="monthlyChart"></canvas>
        </div>

        <!-- Yearly Growth -->
        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
            <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                <i class="bi bi-graph-up text-brand-500"></i> {{ _('Yearly Growth') }}
            </h3>
            <canvas id="yearlyChart"></canvas>
        </div>

        <!-- Last 7 Days -->
        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
            <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                <i class="bi bi-activity text-brand-500"></i> {{ _('Last 7 Days Trend') }}
            </h3>
            <canvas id="dailyChart"></canvas>
        </div>

        <!-- Top States Map/List -->
        <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200">
            <h2 class="text-xl font-bold text-slate-900 mb-6 flex items-center gap-2">
                <i class="bi bi-map-fill text-brand-500"></i> {{ _('Top Participating States') }}
            </h2>

            <div class="space-y-6">
                {% for state, count in top_states %}
                <div>
                    <div class="flex justify-between items-end mb-1">
                        <span class="font-semibold text-slate-700">{{ state }}</span>
                        <span class="font-bold text-slate-900">{{ count }}</span>
                    </div>
                    {% set max_val = top_states[0][1] if top_states else 1 %}
                    {% set width = (count / max_val) * 100 %}
                    <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                        <div class="bg-brand-500 h-full rounded-full transition-all duration-1000"
                            style="width: {{ width }}%"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

    </div>

    <!-- Demographics Section (Credibility) -->
    <div class="mb-16">
        <h2 class="text-3xl font-bold text-slate-900 mb-10 text-center">{{ _('Who Pledges?') }}</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
            <!-- Gender -->
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-center text-slate-800 mb-4">{{ _('Gender Distribution') }}</h3>
                <div class="h-64">
                    <canvas id="genderChart"></canvas>
                </div>
            </div>

            <!-- Age Groups -->
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-center text-slate-800 mb-4">{{ _('Age Groups') }}</h3>
                <div class="h-64">
                    <canvas id="ageChart"></canvas>
                </div>
            </div>
        </div>
    </div>


    <!-- Recent Heroes Ticker -->
    <div class="bg-slate-50 p-8 rounded-3xl border border-slate-200 mb-16">
        <h2 class="text-xl font-bold text-slate-900 mb-6 flex items-center gap-2">
            <i class="bi bi-stars text-amber-500"></i> {{ _('Recent Heroes') }}
        </h2>

        <div class="relative space-y-4 max-h-[400px] overflow-hidden hover:overflow-y-auto pr-2 custom-scrollbar">
            {% for pledge in recent_pledges %}
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4 animate-in fade-in slide-in-from-bottom-2 duration-500"
                style="animation-delay: {{ loop.index0 * 100 }}ms">
                <div
                    class="w-10 h-10 rounded-full bg-brand-100 flex items-center justify-center text-brand-600 font-bold text-sm shrink-0">
                    {{ pledge.initials }}
                </div>
                <div>
                    <div class="font-bold text-slate-900 text-sm">{{ pledge.name }}</div>
                    <div class="text-xs text-slate-500 flex items-center gap-1">
                        <i class="bi bi-geo-alt-fill text-[10px]"></i> {{ pledge.city }}, {{ pledge.state }}
                    </div>
                </div>
                <div class="ml-auto text-xs font-medium text-slate-400">
                    {{ pledge.time_ago }}
                </div>
            </div>
            {% endfor %}

            {% if not recent_pledges %}
            <div class="text-center text-slate-400 py-8">
                {{ _('Be the first hero today!') }}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- CTA -->
    <div class="text-center">
        <h3 class="text-2xl font-bold text-slate-900 mb-4">{{ _('Inspired by these numbers?') }}</h3>
        <a href="{{ url_for('pledge_form') }}"
            class="inline-flex items-center gap-2 px-8 py-4 bg-brand-600 hover:bg-brand-700 text-white font-bold rounded-xl shadow-lg shadow-brand-500/30 transition-all transform hover:-translate-y-1">
            <i class="bi bi-pencil-square"></i> {{ _('Take the Pledge Now') }}
        </a>
    </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#64748b';

        // 1. Monthly Chart (Bar)
        new Chart(document.getElementById('monthlyChart'), {
            type: 'bar',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: [{
                    label: 'Pledges',
                    data: {{ monthly_data | tojson }
        }
                },
        backgroundColor: '#3b82f6',
        borderRadius: 6,
                }]
            },
        options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, grid: { borderDash: [2, 2] } }, x: { grid: { display: false } } }
    }
        });

    // 2. Yearly Chart (Line/Area)
    new Chart(document.getElementById('yearlyChart'), {
        type: 'line',
        data: {
            labels: {{ yearly_labels | tojson }},
        datasets: [{
            label: 'Total Pledges',
            data: {{ yearly_data | tojson }},
        borderColor: '#0ea5e9',
        backgroundColor: 'rgba(14, 165, 233, 0.1)',
        fill: true,
        tension: 0.4
                }]
            },
        options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
    }
        });

    // 3. Last 7 Days (Line)
    new Chart(document.getElementById('dailyChart'), {
        type: 'line',
        data: {
            labels: {{ last_7_dates | tojson }},
        datasets: [{
            label: 'Daily Pledges',
            data: {{ last_7_counts | tojson }},
        borderColor: '#10b981',
        borderWidth: 2,
        pointBackgroundColor: '#fff',
        pointBorderColor: '#10b981',
        pointRadius: 4,
        tension: 0.3
                }]
            },
        options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
            y: { beginAtZero: true, ticks: { precision: 0 } },
            x: { grid: { display: false } }
        }
    }
        });

    // 4. Gender (Doughnut)
    new Chart(document.getElementById('genderChart'), {
        type: 'doughnut',
        data: {
            labels: {{ gender_labels | tojson }},
        datasets: [{
            data: {{ gender_data | tojson }},
        backgroundColor: ['#3b82f6', '#ec4899', '#94a3b8'],
        borderWidth: 0
                }]
            },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } }
    }
        });

    // 5. Age Groups (Pie)
    new Chart(document.getElementById('ageChart'), {
        type: 'pie',
        data: {
            labels: {{ age_labels | tojson }},
        datasets: [{
            data: {{ age_data | tojson }},
        backgroundColor: ['#eab308', '#22c55e', '#ef4444', '#a855f7', '#cbd5e1'],
        borderWidth: 0
                }]
            },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } }
    }
        });
    });
</script>

<style>
    /* Custom Scrollbar for the ticker */
    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 20px;
    }
</style>
{% endblock %}