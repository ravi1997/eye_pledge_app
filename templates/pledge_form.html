{% extends "base.html" %}

{% block title %}Eye Donation Pledge - Step by Step{% endblock %}

{% block extra_css %}
<style>
    /* Wizard Progress Bar */
    .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
        position: relative;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
    }

    .step-indicator::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 2px;
        background: #e2e8f0;
        z-index: 1;
        transform: translateY(-50%);
    }

    .step-item {
        position: relative;
        z-index: 2;
        background: var(--bg2);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: var(--muted);
        border: 2px solid #e2e8f0;
        transition: all 0.3s ease;
    }

    .step-item.active {
        background: var(--brand);
        color: #fff;
        border-color: var(--brand);
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
    }

    .step-item.completed {
        background: #10b981;
        border-color: #10b981;
        color: #fff;
    }

    /* Form Steps Animation */
    .form-step {
        display: none;
        animation: fadeIn 0.4s ease forwards;
    }

    .form-step.active {
        display: block;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Modern Card Overrides */
    .wizard-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        border: 1px solid white;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);
        border-radius: 20px;
        padding: 2rem;
        max-width: 900px;
        margin: 0 auto;
    }

    .form-label {
        font-weight: 500;
        color: var(--text);
        margin-bottom: 0.5rem;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: var(--brand);
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header pb-5">
    <div class="container-main text-center">
        <h1 class="mb-2">Eye Donation Pledge</h1>
        <p class="subtitle mx-auto" style="max-width: 600px;">
            A few simple steps to leave a legacy of sight.
        </p>
    </div>
</div>

<div class="container-main" style="margin-top: -3rem;">
    <!-- Progress Indicator -->
    <div class="step-indicator">
        <div class="step-item active" data-step="1">1</div>
        <div class="step-item" data-step="2">2</div>
        <div class="step-item" data-step="3">3</div>
        <div class="step-item" data-step="4">4</div>
    </div>

    <div class="wizard-card">
        <form method="POST" action="{{ url_for('pledge_form') }}" id="pledgeForm" novalidate>

            <!-- STEP 1: Personal Details -->
            <div class="form-step active" data-step-index="1">
                <h4 class="mb-4 text-brand">1. Personal Information</h4>
                <div class="row g-4">
                    <div class="col-md-6">
                        <label for="donor_name" class="form-label">Full Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="donor_name" name="donor_name" required>
                        <div class="invalid-feedback">Please enter your full name.</div>
                    </div>
                    <div class="col-md-6">
                        <label for="gender" class="form-label">Gender</label>
                        <select class="form-select" id="gender" name="gender">
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="marital_status" class="form-label">Marital Status</label>
                        <select class="form-select" id="marital_status" name="marital_status">
                            <option value="">Select Status</option>
                            <option value="Single">Single</option>
                            <option value="Married">Married</option>
                            <option value="Divorced">Divorced</option>
                            <option value="Widowed">Widowed</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="occupation" class="form-label">Occupation</label>
                        <input type="text" class="form-control" id="occupation" name="occupation"
                            placeholder="e.g. Engineer, Student">
                    </div>
                    <div class="col-md-4">
                        <label for="date_of_birth" class="form-label">Date of Birth</label>
                        <input type="date" class="form-control" id="date_of_birth" name="date_of_birth">
                    </div>
                    <div class="col-md-4">
                        <label for="age" class="form-label">Age</label>
                        <input type="number" class="form-control" id="age" name="age" min="1" max="120" readonly>
                        <small class="text-muted">Auto-calculated</small>
                    </div>
                    <div class="col-md-4">
                        <label for="blood_group" class="form-label">Blood Group</label>
                        <select class="form-select" id="blood_group" name="blood_group">
                            <option value="">Select Group</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label">ID Proof (Indian Standard) <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <select class="form-select" name="id_proof_type" style="max-width: 150px;">
                                <option value="Aadhaar">Aadhaar</option>
                                <option value="PAN">PAN</option>
                                <option value="Voter ID">Voter ID</option>
                                <option value="Driving License">Driving License</option>
                                <option value="Passport">Passport</option>
                            </select>
                            <input type="text" class="form-control" name="id_proof_number" placeholder="Enter ID Number"
                                required>
                        </div>
                    </div>
                </div>
                <div class="mt-4 text-end">
                    <button type="button" class="btn btn-primary px-4 btn-next">Next Step <i
                            class="bi bi-arrow-right ms-2"></i></button>
                </div>
            </div>

            <!-- STEP 2: Address & Contact -->
            <div class="form-step" data-step-index="2">
                <h4 class="mb-4 text-brand">2. Contact & Address</h4>
                <div class="row g-4">
                    <div class="col-md-6">
                        <label for="donor_mobile" class="form-label">Mobile Number <span
                                class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">+91</span>
                            <input type="tel" class="form-control" id="donor_mobile" name="donor_mobile"
                                pattern="[0-9]{10}" placeholder="10-digit number" required>
                        </div>
                        <div class="invalid-feedback">Enter a valid 10-digit mobile number.</div>
                    </div>
                    <div class="col-md-6">
                        <label for="donor_email" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="donor_email" name="donor_email"
                            placeholder="name@example.com">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Address Line 1 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="address_line1" required>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Address Line 2</label>
                        <input type="text" class="form-control" name="address_line2"
                            placeholder="Apartment, Studio, or Floor">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">State / UT <span class="text-danger">*</span></label>
                        <select class="form-select" id="state" name="state" required>
                            <option value="">Select State</option>
                            <option value="Andhra Pradesh">Andhra Pradesh</option>
                            <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                            <option value="Assam">Assam</option>
                            <option value="Bihar">Bihar</option>
                            <option value="Chhattisgarh">Chhattisgarh</option>
                            <option value="Delhi">Delhi</option>
                            <option value="Goa">Goa</option>
                            <option value="Gujarat">Gujarat</option>
                            <option value="Haryana">Haryana</option>
                            <option value="Himachal Pradesh">Himachal Pradesh</option>
                            <option value="Jharkhand">Jharkhand</option>
                            <option value="Karnataka">Karnataka</option>
                            <option value="Kerala">Kerala</option>
                            <option value="Madhya Pradesh">Madhya Pradesh</option>
                            <option value="Maharashtra">Maharashtra</option>
                            <option value="Manipur">Manipur</option>
                            <option value="Meghalaya">Meghalaya</option>
                            <option value="Mizoram">Mizoram</option>
                            <option value="Nagaland">Nagaland</option>
                            <option value="Odisha">Odisha</option>
                            <option value="Punjab">Punjab</option>
                            <option value="Rajasthan">Rajasthan</option>
                            <option value="Sikkim">Sikkim</option>
                            <option value="Tamil Nadu">Tamil Nadu</option>
                            <option value="Telangana">Telangana</option>
                            <option value="Tripura">Tripura</option>
                            <option value="Uttar Pradesh">Uttar Pradesh</option>
                            <option value="Uttarakhand">Uttarakhand</option>
                            <option value="West Bengal">West Bengal</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">City <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="city" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">District</label>
                        <input type="text" class="form-control" name="district">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Pincode <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="pincode" pattern="[0-9]{6}"
                            placeholder="6-digit code" required>
                    </div>
                </div>
                <div class="mt-4 d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-secondary btn-prev"><i
                            class="bi bi-arrow-left me-2"></i> Previous</button>
                    <button type="button" class="btn btn-primary px-4 btn-next">Next Step <i
                            class="bi bi-arrow-right ms-2"></i></button>
                </div>
            </div>

            <!-- STEP 3: Witness (Next of Kin) -->
            <div class="form-step" data-step-index="3">
                <h4 class="mb-4 text-brand">3. Next of Kin / Witness</h4>
                <div class="alert alert-info border-0 bg-soft-brand mb-4">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    A witness (preferably next of kin) is mandatory for the pledge to be registered.
                </div>
                <div class="row g-4">
                    <div class="col-md-6">
                        <label class="form-label">Witness Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="witness1_name" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Relationship <span class="text-danger">*</span></label>
                        <select class="form-select" name="witness1_relationship" required>
                            <option value="">Select Relationship</option>
                            <option value="Father">Father</option>
                            <option value="Mother">Mother</option>
                            <option value="Spouse">Spouse</option>
                            <option value="Child">Child</option>
                            <option value="Sibling">Sibling</option>
                            <option value="Friend">Friend</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Witness Mobile <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">+91</span>
                            <input type="tel" class="form-control" name="witness1_mobile" pattern="[0-9]{10}" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Witness Email</label>
                        <input type="email" class="form-control" name="witness1_email">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Witness Address</label>
                        <textarea class="form-control" name="witness1_address" rows="2"></textarea>
                    </div>
                </div>

                <hr class="my-4">
                <h5 class="text-muted mb-3">Second Witness (Optional)</h5>
                <div class="row g-4">
                    <div class="col-md-6">
                        <label class="form-label">Witness Name</label>
                        <input type="text" class="form-control" name="witness2_name">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Relationship</label>
                        <select class="form-select" name="witness2_relationship">
                            <option value="">Select Relationship</option>
                            <option value="Father">Father</option>
                            <option value="Mother">Mother</option>
                            <option value="Spouse">Spouse</option>
                            <option value="Child">Child</option>
                            <option value="Sibling">Sibling</option>
                            <option value="Friend">Friend</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Witness Mobile</label>
                        <div class="input-group">
                            <span class="input-group-text">+91</span>
                            <input type="tel" class="form-control" name="witness2_mobile" pattern="[0-9]{10}">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Witness Email</label>
                        <input type="email" class="form-control" name="witness2_email">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Witness Address</label>
                        <textarea class="form-control" name="witness2_address" rows="1"></textarea>
                    </div>
                </div>
                <div class="mt-4 d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-secondary btn-prev"><i
                            class="bi bi-arrow-left me-2"></i> Previous</button>
                    <button type="button" class="btn btn-primary px-4 btn-next">Next Step <i
                            class="bi bi-arrow-right ms-2"></i></button>
                </div>
            </div>

            <!-- STEP 4: Pledge & Consent -->
            <div class="form-step" data-step-index="4">
                <h4 class="mb-4 text-brand">4. Final Consent</h4>

                <div class="card bg-light border-0 mb-4">
                    <div class="card-body">
                        <h5 class="card-title fw-bold">My Wish</h5>
                        <div class="mb-3">
                            <label class="form-label">I wish to donate:</label>
                            <select class="form-select" name="organs_consented">
                                <option value="Both eyes" selected>Both Eyes (Recommended)</option>
                                <option value="Cornea only">Corneas Only</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Place of Pledge</label>
                            <input type="text" class="form-control" name="place" placeholder="e.g. Mumbai">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Preferred Eye Bank (Optional)</label>
                            <input type="text" class="form-control" name="preferred_eye_bank">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Additional Notes</label>
                            <textarea class="form-control" name="additional_notes" rows="2"></textarea>
                        </div>
                    </div>

                    <p class="text-muted small mb-0">
                        By submitting this form, I hereby pledge to donate my eyes after my death to be used for
                        therapeutic, research, or education purposes. I understand my family will be the final
                        authority to execute this wish, so I will inform them.
                    </p>
                </div>
            </div>

            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="consent_check" name="donor_consent" required>
                <label class="form-check-label" for="consent_check">
                    <strong>I solemnly Pledge to donate my eyes.</strong> <span class="text-danger">*</span>
                </label>
            </div>

            <div class="form-check mb-4">
                <input class="form-check-input" type="checkbox" name="acknowledged_revocability" checked>
                <label class="form-check-label text-muted small">
                    I understand this pledge is voluntary and can be revoked at any time.
                </label>
            </div>

            <!-- Hidden Date Field -->
            <input type="hidden" name="date_of_pledge" id="date_of_pledge">

            <div class="mt-4 d-flex justify-content-between">
                <button type="button" class="btn btn-outline-secondary btn-prev"><i class="bi bi-arrow-left me-2"></i>
                    Previous</button>
                <button type="submit" class="btn btn-success px-5 btn-lg shadow-sm">
                    <i class="bi bi-heart-fill me-2"></i> Confirm Pledge
                </button>
            </div>
    </div>

    </form>
</div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const steps = document.querySelectorAll('.form-step');
        const indicators = document.querySelectorAll('.step-item');
        let currentStep = 0;

        // Set today's date
        document.getElementById('date_of_pledge').value = new Date().toISOString().split('T')[0];

        // Age Calculation
        const dobInput = document.getElementById('date_of_birth');
        const ageInput = document.getElementById('age');
        dobInput.addEventListener('change', function () {
            if (this.value) {
                const dob = new Date(this.value);
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                const m = today.getMonth() - dob.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
                    age--;
                }
                ageInput.value = age;
            }
        });

        // Validations
        function validateStep(index) {
            const step = steps[index];
            const inputs = step.querySelectorAll('input[required], select[required]');
            let valid = true;

            inputs.forEach(input => {
                if (!input.checkValidity()) {
                    input.reportValidity();
                    valid = false;
                    // Add visual error
                    input.classList.add('is-invalid');
                } else {
                    input.classList.remove('is-invalid');
                }
            });
            return valid;
        }

        // Navigation
        document.querySelectorAll('.btn-next').forEach(btn => {
            btn.addEventListener('click', () => {
                if (validateStep(currentStep)) {
                    if (currentStep < steps.length - 1) {
                        currentStep++;
                        updateUI();
                    }
                }
            });
        });

        document.querySelectorAll('.btn-prev').forEach(btn => {
            btn.addEventListener('click', () => {
                if (currentStep > 0) {
                    currentStep--;
                    updateUI();
                }
            });
        });

        function updateUI() {
            // Update Steps
            steps.forEach((step, idx) => {
                step.classList.remove('active');
                if (idx === currentStep) step.classList.add('active');
            });

            // Update Indicators
            indicators.forEach((ind, idx) => {
                ind.classList.remove('active', 'completed');
                if (idx === currentStep) ind.classList.add('active');
                if (idx < currentStep) {
                    ind.classList.add('completed');
                    ind.innerHTML = '<i class="bi bi-check-lg"></i>';
                } else {
                    ind.textContent = idx + 1;
                }
            });

            // Scroll to top of form
            window.scrollTo({ top: 100, behavior: 'smooth' });
        }
    });
</script>
{% endblock %}